<!-- Wrapper: يغيّر الاتجاه تلقائياً حسب اللغة -->
<div class="shipments-table-wrap" [attr.dir]="currentLang === 'ar' ? 'rtl' : 'ltr'">

  <!-- Table -->
  <table #shipmentsTable class="table table-hover mb-0 align-middle responsive-table">
    <thead>
      <tr class="bg-danger">
        <th>{{ currentLang === 'ar' ? 'رقم الشحنة' : 'Tracking Number' }}</th>
        <th>{{ currentLang === 'ar' ? 'نوع الشحنة' : 'Shipment Type' }}</th>
        <th>{{ currentLang === 'ar' ? 'حالة الشحنة' : 'Shipment Status' }}</th>
        <th>{{ currentLang === 'ar' ? 'التاريخ' : 'Date' }}</th>
        <th class="">{{ currentLang === 'ar' ? 'الحجم (CBM)' : 'CBM (Sea)' }}</th>

        <!-- NEW: Total Cartons -->
        <th class="">{{ currentLang === 'ar' ? 'إجمالي الكراتين' : 'Total Cartons' }}</th>

        <th class="">{{ currentLang === 'ar' ? 'الوزن (كجم)' : 'Weight (Air)' }}</th>
        <th class="">{{ currentLang === 'ar' ? 'تكلفة الشحن' : 'Shipping Cost' }}</th>
        <th class="text-center">{{ currentLang === 'ar' ? 'الإجراءات' : 'Actions' }}</th>
      </tr>
    </thead>

    <tbody>
      @for (shipment of recentOrder; track shipment) {
        <tr>
          <td>
            <a href="javascript:" class="text-muted fw-semibold">
              {{ shipment.shipment_number || '-' }}
            </a>
          </td>

          <!-- Shipment Type with safe Arabic translation -->
          <td class="text-capitalize">
            <i class="bi me-1"
               [ngClass]="{
                 'bi-airplane': shipment.shipment_type === 'air',
                 'bi-truck': shipment.shipment_type === 'sea'
               }"></i>

            <ng-container *ngIf="currentLang === 'ar'">
              <ng-container *ngIf="shipment.shipment_type === 'sea'">بحري</ng-container>
              <ng-container *ngIf="shipment.shipment_type === 'air'">جوي</ng-container>
              <ng-container *ngIf="shipment.shipment_type && shipment.shipment_type !== 'sea' && shipment.shipment_type !== 'air'">
                {{ shipment.shipment_type }}
              </ng-container>
              <ng-container *ngIf="!shipment.shipment_type">-</ng-container>
            </ng-container>

            <ng-container *ngIf="currentLang !== 'ar'">
              {{ shipment.shipment_type || '-' }}
            </ng-container>
          </td>

          <!-- Shipment Status (badge) -->
<!-- status cell (داخل حلقة recentOrder) -->
<td class="status-td position-relative d-flex justify-content-center align-items-center">
  <div class="d-flex align-items-center gap-2">
    <!-- badge current status -->
    <span class="badge px-3 py-2" [ngClass]="getStatusBadgeClasses(shipment.shipment_status)">
      {{ getStatusLabel(shipment.shipment_status, shipment) }}
    </span>

    <!-- Bootstrap dropdown (toggle) -->
    <div class="dropdown" [class.show]="inlineDropdownOpenId === shipment.id">
     <button
  #statusBtn
  class="btn btn-sm btn-outline-secondary dropdown-toggle"
  type="button"
  (click)="toggleInlineDropdown(shipment, $event)"
  [attr.aria-expanded]="inlineDropdownOpenId === shipment.id"
  [disabled]="updatingStatusId === shipment.id"
  [attr.title]="currentLang === 'ar' ? 'تعديل الحالة' : 'Edit status'">
  <i class="fa-solid fa-pen-to-square"></i>
</button>

      <!-- dropdown menu -->
      <ul class="dropdown-menu shadow-sm p-2"
    [class.show]="inlineDropdownOpenId === shipment.id"
    [attr.aria-labelledby]="'statusDropdownBtn_' + shipment.id"
    [ngStyle]="inlineDropdownOpenId === shipment.id ? dropdownMenuStyles : {}">

        <li *ngFor="let s of statusOptions">
          <button
            class="dropdown-item d-flex justify-content-between align-items-center"
            type="button"
            (click)="selectInlineStatus(shipment, s.key)"
            [class.active]="shipment.shipment_status === s.key">
            <span>{{ getStatusLabel(s.key, shipment) }}</span>
            <i *ngIf="shipment.shipment_status === s.key" class="fa-solid fa-check text-success"></i>
          </button>
        </li>

        <li><hr class="dropdown-divider"></li>

      <li class="action-buttons px-2 d-flex gap-2 justify-content-end">
  <button class="btn cancel-btn text-white" type="button" (click)="closeInlineDropdown()">
    {{ currentLang === 'ar' ? 'إلغاء' : 'Cancel' }}
  </button>

  <button
    class="btn save-btn"
    type="button"
    (click)="confirmInlineStatusUpdate(shipment)"
    [disabled]="!selectedInlineStatus || selectedInlineStatus === shipment.shipment_status || updatingStatusId === shipment.id"
  >
    <ng-container *ngIf="updatingStatusId !== shipment.id">
      {{ currentLang === 'ar' ? 'حفظ' : 'Save' }}
    </ng-container>
    <ng-container *ngIf="updatingStatusId === shipment.id">
      <span class="spinner-border spinner-border-sm me-1 text-white" role="status" aria-hidden="true"></span>
      {{ currentLang === 'ar' ? 'جاري الحفظ...' : 'Saving...' }}
    </ng-container>
  </button>
</li>


      </ul>
    </div>
  </div>

  <!-- optional: show inline messages -->
  <div *ngIf="inlineError && inlineForId === shipment.id" class="mt-2">
    <div class="alert alert-danger py-1 mb-0">{{ inlineError }}</div>
  </div>
  <div *ngIf="inlineSuccess && inlineForId === shipment.id" class="mt-2">
    <div class="alert alert-success py-1 mb-0">{{ inlineSuccess }}</div>
  </div>
</td>


          <td>
            <span class="text-muted">
              {{
                shipment.expected_arrival_date
                  ? (shipment.expected_arrival_date | date: 'mediumDate')
                  : (shipment.created_at | date: 'mediumDate')
              }}
            </span>
          </td>

          <td class="">
            <span *ngIf="shipment.shipment_type === 'sea'; else noSeaData">
              {{ shipment.total_cbm ? (shipment.total_cbm + ' cbm') : '-' }}
            </span>
            <ng-template #noSeaData> - </ng-template>
          </td>

          <!-- TOTAL CARTONS: يظهر دائماً سواء sea أو air -->
          <td class="">
            {{ shipment.total_cartons !== null ? (shipment.total_cartons | number) : '-' }}
          </td>

          <td class="">
            <span *ngIf="shipment.shipment_type === 'air'; else noAirData">
              {{ shipment.total_weight ? (shipment.total_weight + ' kg') : '-' }}
            </span>
            <ng-template #noAirData> - </ng-template>
          </td>

          <td class="">
            {{ formatMoney(shipment.total_cost) }}
          </td>

          <!-- Actions -->
          <td class="text-center d-flex justify-content-center gap-2">
            <button
              class="btn btn-sm btn-danger"
              (click)="deleteShipment(shipment)"
              [disabled]="deletingId === shipment.id"
              [attr.title]="currentLang === 'ar' ? 'حذف' : 'Delete'">
              <ng-container *ngIf="deletingId !== shipment.id">
                <i class="fa-solid fa-trash"></i>
                <span class="d-none d-sm-inline"> {{ currentLang === 'ar' ? 'حذف' : 'Delete' }} </span>
              </ng-container>
              <ng-container *ngIf="deletingId === shipment.id">
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                {{ currentLang === 'ar' ? 'جاري الحذف...' : 'Deleting...' }}
              </ng-container>
            </button>

            <button
              class="btn btn-sm btn-secondary"
              (click)="openEdit(shipment)"
              [disabled]="updatingId === shipment.id"
              [attr.title]="currentLang === 'ar' ? 'تعديل' : 'Edit'">
              <ng-container *ngIf="updatingId !== shipment.id">
                <i class="fa-solid fa-pen-to-square"></i>
                <span class="d-none d-sm-inline"> {{ currentLang === 'ar' ? 'تعديل' : 'Edit' }} </span>
              </ng-container>
              <ng-container *ngIf="updatingId === shipment.id">
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                {{ currentLang === 'ar' ? 'جاري الحفظ...' : 'Saving...' }}
              </ng-container>
            </button>
          </td>
        </tr>
      } @empty {
        <tr>
          <!-- colspan updated to 9 -->
          <td colspan="9" class="text-center text-muted py-3">
            {{ currentLang === 'ar' ? 'لا توجد شحنات.' : 'No shipments found.' }}
          </td>
        </tr>
      }
    </tbody>
  </table>

  <!-- Edit Modal (يبقى كما في كودك مع الحقول الخاصة بالـ total_cartons موجودة) -->
  <!-- ... مودال التعديل و status modal كما في كودك الحالي ... -->

</div>


  <!-- Edit Modal -->
  <div class="modal-backdrop" *ngIf="showEditModal" (click)="closeEdit()"></div>

  <div class="custom-modal" *ngIf="showEditModal" role="dialog" aria-modal="true" aria-labelledby="editShipmentTitle">
    <div class="modal-card">
      <div class="modal-header d-flex justify-content-between align-items-center">
        <h5 id="editShipmentTitle" class="mb-0">
          {{ currentLang === 'ar' ? 'تعديل الشحنة' : 'Edit Shipment' }}
        </h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="closeEdit()"></button>
      </div>

      <form #editForm="ngForm" (ngSubmit)="saveEdit(editForm)" novalidate>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label fw-medium">
                {{ currentLang === 'ar' ? 'رقم الشحنة' : 'Shipment Number' }}
              </label>
              <input name="shipment_number" class="form-control"
                     [(ngModel)]="editingShipment.shipment_number"
                     required />
            </div>

            <div class="col-md-6">
              <label class="form-label fw-medium">
                {{ currentLang === 'ar' ? 'نوع الشحنة' : 'Shipment Type' }}
              </label>
              <select name="shipment_type" class="form-select"
                      [(ngModel)]="editingShipment.shipment_type" required>
                <option value="sea">{{ currentLang === 'ar' ? 'بحري' : 'Sea' }}</option>
                <option value="air">{{ currentLang === 'ar' ? 'جوي' : 'Air' }}</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-medium">
                {{ currentLang === 'ar' ? 'حالة الشحنة' : 'Shipment Status' }}
              </label>
              <select name="shipment_status" class="form-select"
                      [(ngModel)]="editingShipment.shipment_status" required>
                <option value="pending">{{ currentLang === 'ar' ? 'قيد الانتظار' : 'Pending' }}</option>
                <option value="shipped">{{ currentLang === 'ar' ? 'تم الشحن' : 'Shipped' }}</option>
                <option value="received_in_china">{{ currentLang === 'ar' ? 'تم الاستلام في الصين' : 'Received in China' }}</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-medium">
                {{ currentLang === 'ar' ? 'تاريخ الوصول المتوقع' : 'Expected Arrival Date' }}
              </label>
              <input type="date" name="expected_arrival_date" class="form-control"
                     [(ngModel)]="editingShipment.expected_arrival_date" />
            </div>

            <!-- Sea fields -->
            <div class="col-md-6" *ngIf="editingShipment.shipment_type === 'sea'">
              <label class="form-label fw-medium">
                {{ currentLang === 'ar' ? 'إجمالي الكراتين' : 'Total Cartons' }}
              </label>
              <input type="number" name="total_cartons" class="form-control"
                     [(ngModel)]="editingShipment.total_cartons" min="0" />
            </div>

            <div class="col-md-6" *ngIf="editingShipment.shipment_type === 'sea'">
              <label class="form-label fw-medium">
                {{ currentLang === 'ar' ? 'إجمالي CBM' : 'Total CBM' }}
              </label>
              <input type="number" name="total_cbm" class="form-control"
                     [(ngModel)]="editingShipment.total_cbm" min="0" step="0.01" />
            </div>

            <!-- Air fields -->
            <div class="col-md-6" *ngIf="editingShipment.shipment_type === 'air'">
              <label class="form-label fw-medium">
                {{ currentLang === 'ar' ? 'إجمالي الوزن (كجم)' : 'Total Weight (kg)' }}
              </label>
              <input type="number" name="total_weight" class="form-control"
                     [(ngModel)]="editingShipment.total_weight" min="0" step="0.01" />
            </div>

            <div class="col-md-6">
              <label class="form-label fw-medium">
                {{ currentLang === 'ar' ? 'إجمالي التكلفة' : 'Total Cost' }}
              </label>
              <input type="number" name="total_cost" class="form-control"
                     [(ngModel)]="editingShipment.total_cost" min="0" step="0.01" />
            </div>

            <div class="col-12">
              <div *ngIf="addError" class="alert alert-danger">{{ addError }}</div>
              <div *ngIf="addSuccess" class="alert alert-success">{{ addSuccess }}</div>
            </div>
          </div>
        </div>

        <div class="modal-footer d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-secondary" (click)="closeEdit()" [disabled]="editingSaving">
            {{ currentLang === 'ar' ? 'إلغاء' : 'Cancel' }}
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="editingSaving || editForm.invalid">
            <ng-container *ngIf="!editingSaving">{{ currentLang === 'ar' ? 'حفظ التعديلات' : 'Save changes' }}</ng-container>
            <ng-container *ngIf="editingSaving">
              <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
              {{ currentLang === 'ar' ? 'جاري الحفظ...' : 'Saving...' }}
            </ng-container>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Status Modal -->
 